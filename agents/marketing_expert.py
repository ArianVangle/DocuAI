# agents/marketing_expert.py
from langchain_gigachat import GigaChat
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
import os

def generate_ab_tests(document_text: str, user_query: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ A/B-—Ç–µ—Å—Ç—ã –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ:
    - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    - –¶–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –ü—Ä–∏–Ω—Ü–∏–ø–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã B2B

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ + –æ—Ü–µ–Ω–∫—É –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
    """
    llm = GigaChat(
        credentials=os.getenv("API_KEY"),
        model="GigaChat", 
        verify_ssl_certs=False
    )
    
    prompt = ChatPromptTemplate.from_messages([
        ("system", "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ B2B-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. "
                   "–°–æ–∑–¥–∞–π –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ A/B-—Ç–µ—Å—Ç–∞ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

                   "üî• –ü—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:\n"
                   "1. **–í–∞—Ä–∏–∞–Ω—Ç A**: –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)\n"
                   "2. **–í–∞—Ä–∏–∞–Ω—Ç B**: –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ë–ò–ó–ù–ï–°-–í–´–ì–û–î–ê–• (—ç–∫–æ–Ω–æ–º–∏—è, ROI, —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤, —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–≤–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫)\n"
                   "3. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –¶–ò–§–†–´** –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ –ª–æ–≥–∏—á–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ (¬´–Ω–∞ 40%¬ª, ¬´—Å 8 —á–∞—Å–æ–≤ –¥–æ 15 –º–∏–Ω—É—Ç¬ª)\n"
                   "4. –£—á–∏—Ç—ã–≤–∞–π —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (DevOps, CTO, –º–µ–Ω–µ–¥–∂–µ—Ä—ã –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ —Ç.–¥.)\n"
                   "5. –°–¥–µ–ª–∞–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–µ–ª–æ ‚Äî 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n"
                   "6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ ¬´–Ω–∞–¥—ë–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ¬ª ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞\n\n"

                   "üìä –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ü–µ–Ω–∏ –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10 –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:\n"
                   "- –Ø—Å–Ω–æ—Å—Ç—å –≤—ã–≥–æ–¥—ã\n"
                   "- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏\n"
                   "- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n\n"

                   "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):\n"
                   "A: [–∑–∞–≥–æ–ª–æ–≤–æ–∫]\n[—Ç–µ–ª–æ]\n\n"
                   "B: [–∑–∞–≥–æ–ª–æ–≤–æ–∫]\n[—Ç–µ–ª–æ]\n\n"
                   "üìà –û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n"
                   "‚Ä¢ A: X/10 ‚Äî [1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –ø–æ—á–µ–º—É —Ç–∞–∫–∞—è –æ—Ü–µ–Ω–∫–∞]\n"
                   "‚Ä¢ B: Y/10 ‚Äî [1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –ø–æ—á–µ–º—É —Ç–∞–∫–∞—è –æ—Ü–µ–Ω–∫–∞]\n"
                   "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [–∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±—Ä–∞—Ç—å –¥–ª—è –¥–∞–Ω–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏ –ø–æ—á–µ–º—É]\n\n"

                   "–î–æ–∫—É–º–µ–Ω—Ç:\n{document}"),
        ("human", "–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_query}\n\n"
                  "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π A/B-—Ç–µ—Å—Ç—ã —Å—Ç—Ä–æ–≥–æ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ù–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–π.")
    ])
    
    chain = prompt | llm | StrOutputParser()
    return chain.invoke({"document": document_text, "user_query": user_query})