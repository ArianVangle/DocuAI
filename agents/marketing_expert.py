# agents/marketing_expert.py
from langchain_gigachat import GigaChat
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
import os

def detect_industry_with_llm(user_query: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—Ç—Ä–∞—Å–ª—å —Å –ø–æ–º–æ—â—å—é GigaChat"""
    llm = GigaChat(
        credentials=os.getenv("API_KEY"),
        model="GigaChat",
        verify_ssl_certs=False
    )
    
    prompt = ChatPromptTemplate.from_messages([
        ("system", "–¢—ã ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ—Ç—Ä–∞—Å–ª–µ–π. –û–ø—Ä–µ–¥–µ–ª–∏ –æ—Ç—Ä–∞—Å–ª—å –∑–∞–ø—Ä–æ—Å–∞.\n\n"
                   "–í–∞—Ä–∏–∞–Ω—Ç—ã: healthcare, construction, finance, industry, education, it, general.\n"
                   "–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ—Ç—Ä–∞—Å–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: healthcare)."),
        ("human", "–ó–∞–ø—Ä–æ—Å: {query}")
    ])
    
    chain = prompt | llm | StrOutputParser()
    try:
        industry = chain.invoke({"query": user_query}).strip().lower()
        valid = {"healthcare", "construction", "finance", "industry", "education", "it", "general"}
        return industry if industry in valid else "general"
    except:
        return "general"

def get_industry_prompts(industry: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
    industry_rules = {
        "healthcare": (
            "–û–°–û–ë–ï–ù–ù–û–°–¢–ò –û–¢–†–ê–°–õ–ò (–º–µ–¥–∏—Ü–∏–Ω–∞):\n"
            "- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö (HIPAA, –ú–∏–Ω–∑–¥—Ä–∞–≤), –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö\n"
            "- –£–ø–æ–º–∏–Ω–∞–π: –≠–ú–ö, —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω–∞, –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n"
            "- –ò–∑–±–µ–≥–∞–π: '–ª–µ—á–µ–Ω–∏–µ', '–≥–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏—è'\n"
            "- –î–æ–±–∞–≤–ª—è–π: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ú–∏–Ω–∑–¥—Ä–∞–≤–∞'\n\n"
        ),
        "construction": (
            "–û–°–û–ë–ï–ù–ù–û–°–¢–ò –û–¢–†–ê–°–õ–ò (—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ):\n"
            "- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö (BIM, —ç–Ω–µ—Ä–≥–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞—Ö (–ì–û–°–¢, –°–ü)\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ü–∏—Ñ—Ä—ã: '—Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ 30%', '–æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å –∑–∞ 5 –ª–µ—Ç'\n"
            "- –£–ø–æ–º–∏–Ω–∞–π: –ñ–ö, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫, –ø—Ä–æ—á–Ω–æ—Å—Ç—å, –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å\n\n"
        ),
        "finance": (
            "–û–°–û–ë–ï–ù–ù–û–°–¢–ò –û–¢–†–ê–°–õ–ò (—Ñ–∏–Ω–∞–Ω—Å—ã):\n"
            "- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (PCI DSS) –∏ –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–∏ (–¶–ë –†–§)\n"
            "- –£–ø–æ–º–∏–Ω–∞–π: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ. –õ–∏—Ü–µ–Ω–∑–∏—è –¶–ë –†–§ ‚Ññ...'\n"
            "- –ò–∑–±–µ–≥–∞–π: '–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å', '–±–µ–∑ —Ä–∏—Å–∫–∞'\n"
            "- –î–µ–ª–∞–π —É–ø–æ—Ä –Ω–∞: —É–¥–æ–±—Å—Ç–≤–æ, —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å\n\n"
        ),
        "industry": (
            "–û–°–û–ë–ï–ù–ù–û–°–¢–ò –û–¢–†–ê–°–õ–ò (–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å):\n"
            "- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö (–ö–ü–î, —Ä–µ—Å—É—Ä—Å) –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö (–ì–û–°–¢, ISO)\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: OEE, TCO, MTBF\n"
            "- –£–ø–æ–º–∏–Ω–∞–π: –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, —Ü–µ—Ö, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è\n\n"
        ),
        "education": (
            "–û–°–û–ë–ï–ù–ù–û–°–¢–ò –û–¢–†–ê–°–õ–ò (–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ):\n"
            "- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö (–±–∞–ª–ª—ã –ï–ì–≠, –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ) –∏ —É–¥–æ–±—Å—Ç–≤–µ\n"
            "- –°—Å—ã–ª–∞–π—Å—è –Ω–∞: –§–ì–û–°, –ü–û–û–ù\n"
            "- –ò–∑–±–µ–≥–∞–π: '–≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è'\n"
            "- –£–ø–æ–º–∏–Ω–∞–π: —à–∫–æ–ª–∞, –í–£–ó, EdTech, –æ–Ω–ª–∞–π–Ω-–æ–±—É—á–µ–Ω–∏–µ\n\n"
        ),
        "it": (
            "–û–°–û–ë–ï–ù–ù–û–°–¢–ò –û–¢–†–ê–°–õ–ò (IT):\n"
            "- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö (Kubernetes, CI/CD) –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: SaaS, API, DevOps, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å\n"
            "- –£–ø–æ–º–∏–Ω–∞–π: –æ–±–ª–∞—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è\n\n"
        )
    }
    return industry_rules.get(industry, "")

def generate_ab_tests(document_text: str, user_query: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç A/B-—Ç–µ—Å—Ç—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç—Ä–∞—Å–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    llm = GigaChat(
        credentials=os.getenv("API_KEY"),
        model="GigaChat",
        verify_ssl_certs=False
    )
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç—Ä–∞—Å–ª—å —á–µ—Ä–µ–∑ LLM
    industry = detect_industry_with_llm(user_query)
    industry_rules = get_industry_prompts(industry)
    
    prompt = ChatPromptTemplate.from_messages([
        ("system", "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ B2B-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É. –°–æ–∑–¥–∞–π A/B-—Ç–µ—Å—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
                   "üî• –û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:\n"
                   "1. –í–∞—Ä–∏–∞–Ω—Ç A: –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)\n"
                   "2. –í–∞—Ä–∏–∞–Ω—Ç B: –ë–ò–ó–ù–ï–°-–í–´–ì–û–î–´ (—ç–∫–æ–Ω–æ–º–∏—è, ROI, —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤)\n"
                   "3. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –¶–ò–§–†–´ (¬´–Ω–∞ 40%¬ª, ¬´—Å 8 —á–∞—Å–æ–≤ –¥–æ 15 –º–∏–Ω—É—Ç¬ª)\n"
                   "4. –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–µ–ª–æ ‚Äî 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ–¥—Ä–æ–±–Ω–æ\n"
                   "5. –ù–∏–∫–∞–∫–∏—Ö –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞\n\n"
                   f"{industry_rules}"  # ‚Üê –î–û–ë–ê–í–õ–Ø–ï–ú –û–¢–†–ê–°–õ–ï–í–´–ï –ü–†–ê–í–ò–õ–ê
                   "üìä –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ü–µ–Ω–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10:\n"
                   "- –Ø—Å–Ω–æ—Å—Ç—å –≤—ã–≥–æ–¥—ã\n"
                   "- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏\n"
                   "- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n\n"
                   "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–°–¢–†–û–ì–û):\n"
                   "A: [–∑–∞–≥–æ–ª–æ–≤–æ–∫]\n[—Ç–µ–ª–æ]\n\n"
                   "B: [–∑–∞–≥–æ–ª–æ–≤–æ–∫]\n[—Ç–µ–ª–æ]\n\n"
                   "üìà –û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n"
                   "‚Ä¢ A: X/10 ‚Äî [–ø—Ä–∏—á–∏–Ω–∞]\n"
                   "‚Ä¢ B: Y/10 ‚Äî [–ø—Ä–∏—á–∏–Ω–∞]\n"
                   "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [–∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å –∏ –ø–æ—á–µ–º—É]\n\n"
                   "–î–æ–∫—É–º–µ–Ω—Ç:\n{document}"),
        ("human", "–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_query}\n\n"
                  "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π A/B-—Ç–µ—Å—Ç—ã —Å—Ç—Ä–æ–≥–æ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.")
    ])
    
    chain = prompt | llm | StrOutputParser()
    return chain.invoke({"document": document_text, "user_query": user_query})